{% extends "base.html" %}

{% block title %}Edit Tournament - Pelotourney{% endblock %}

{% block head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/css/bootstrap-select.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/js/bootstrap-select.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>

  <script>
    function activateTab() {
      if (window.location.hash) {
        const selectedTabElement = document.querySelector(`${window.location.hash}-tab`);
        if (selectedTabElement) {
          const selectedTab = new bootstrap.Tab(selectedTabElement);
          selectedTab.show();
        }
      }
    }
    window.addEventListener("hashchange", activateTab);
    window.addEventListener("DOMContentLoaded", activateTab);
    {% include "tournaments/components/team-list.js" %}
  </script>
{% endblock %}

{% block content %}
  <div class="mx-auto" style="max-width: 992px;">
    <div class="d-flex flex-row align-items-center mb-2">
      <h3 class="mb-0 me-auto">Edit Tournament</h3>
      <a href="{% url "tournaments:detail" tournament.uid %}" class="btn btn-secondary">Back to Tournament</a>
    </div>
    <p class="text-muted">{{ tournament.name }}</p>

    <div class="d-flex align-items-start">
      <div class="nav flex-column nav-pills me-3" id="editor-tabs" role="tablist" aria-orientation="vertical">
        <button class="nav-link active" id="settings-tab" data-bs-toggle="pill" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="true">Settings</button>
        <button class="nav-link" id="teams-tab" data-bs-toggle="pill" data-bs-target="#teams" type="button" role="tab" aria-controls="teams" aria-selected="false">Teams</button>
        <button class="nav-link" id="rides-tab" data-bs-toggle="pill" data-bs-target="#rides" type="button" role="tab" aria-controls="rides" aria-selected="false">Rides</button>
        <button class="nav-link" id="permissions-tab" data-bs-toggle="pill" data-bs-target="#permissions" type="button" role="tab" aria-controls="permissions" aria-selected="false">Permissions</button>
      </div>
      <div class="tab-content border-start border-dark ps-4 w-100" id="tabContent">
        <div class="tab-pane fade show active" id="settings" role="tabpanel" aria-labelledby="settings-tab">
          {% include "tournaments/edit-form.html" with tournament=tournament submit_to="tournaments:edit" %}
        </div>

        <div class="tab-pane fade w-100" id="teams" role="tabpanel" aria-labelledby="teams-tab">
          <h4>Unassigned</h4>
          <div class="row row-cols-1 row-cols-lg-3 row-cols-md-2 g-4 mb-4">
            <div class="col">
              <div class="card h-100">
                <div id="team-unassigned" class="sortable-team list-group list-group-flush" style="min-height: 3rem;">
                  {% include "tournaments/components/team-members.html" with members=tournament.unassigned.all editable=True %}
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card align-items-center">
                <button type="button" class="btn btn-link text-decoration-none w-100"
                        data-bs-toggle="modal" data-bs-target="#add-rider-modal">
                  <i class="bi-plus-circle pe-2"></i><span>Add Rider</span>
                </button>
              </div>
              <div class="modal fade" id="add-rider-modal" tabindex="-1" aria-labelledby="add-rider-modal-label" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <form action="{% url "tournaments:rider_search" tournament.uid %}" method="post">
                      {% csrf_token %}
                      <div class="modal-header bg-light">
                        <h5 class="modal-title text-secondary" id="add-rider-modal-label">Add Peloton Riders</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <div class="input-group col-12">
                          <label class="d-none" for="rider_query">Enter a username</label>
                          <input list="rider_list" class="form-control" id="rider_query" autocomplete="off" name="rider_query" placeholder="Enter a username">
                          <span class="input-group-text" id="basic-addon2"><i class="bi-search"></i></span>
                          <datalist id="rider_list"></datalist>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add Rider</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <h4>Teams</h4>
          <div class="row row-cols-1 row-cols-lg-3 row-cols-md-2 g-4 mb-4">
            {% include "tournaments/components/team-list.html" with tournament=tournament editable=True %}
          </div>
          <button class="btn btn-primary" onclick="saveTeams();">Save Changes</button>
        </div>

        <div class="tab-pane fade" id="rides" role="tabpanel" aria-labelledby="rides-tab">
          <div class="row row-cols-1 row-cols-lg-3 row-cols-md-2 g-4">
            {% for ride in tournament.rides.all %}
            <div class="col">
              <div class="card h-100">
                <img src="{{ ride.image_url }}" class="card-img-top" alt="{{ ride.title }}" style="height: 18vh; object-fit: cover;">
                <div class="card-body p-2 d-flex flex-row">
                  <img class="rounded-circle my-auto me-2"
                       src="{{ ride.instructor.image_url }}" alt="{{ ride.instructor.name }}" width="32" height="32">
                  <div class="col text-truncate">
                    <div class="text-truncate">{{ ride.title }}</div>
                    <div>
                      <small class="text-muted">{{ ride.instructor.name }}</small>
                    </div>
                  </div>
                  <button type="button" data-bs-toggle="modal" data-bs-target="#delete-ride-{{ ride.id }}-modal"
                          class="btn btn-link ms-auto text-secondary hover-danger px-1">
                    <i class="bi-x-circle-fill"></i>
                  </button>
                </div>
                <div class="card-footer">
                  <small class="text-muted">{{ ride.scheduled_start_time|date:"D n/j/y @ g:i A" }}</small>
                </div>
              </div>
            </div>
            <div class="modal fade" id="delete-ride-{{ ride.id }}-modal"
                 tabindex="-1" aria-labelledby="delete-ride-{{ ride.id }}-modal-label" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="delete-ride-{{ ride.id }}-modal-label">Remove Ride</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <p>Are you sure you want to remove "{{ ride.title }}" from the tournament?</p>
                    <small class="text-muted mb-0">NOTE: It can be added back later and all existing ride data will still be synced.</small>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" onclick="deleteRide('{{ ride.id }}');">Remove Ride</button>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
            <div class="col">
              <div class="card h-100 align-items-center">
                <button type="button" data-bs-toggle="modal" data-bs-target="#add-ride-modal"
                        class="btn btn-link text-decoration-none w-100 h-100 py-3">
                  <i class="bi-plus-circle d-block fs-1"></i>
                  <span class="d-block fs-4">Add Ride</span>
                </button>

                <div class="modal fade" id="add-ride-modal" tabindex="-1" aria-labelledby="add-ride-modal-label" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-scrollable">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="add-ride-modal-label">Add Ride</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body py-0">
                        <div id="ride-modal-filters" class="row row-cols-2 sticky-top bg-white border-bottom py-3">
                          <div class="col">
                            <label for="ride-modal-instructor-id" class="d-none">Instructor</label>
                            <select id="ride-modal-instructor-id" class="selectpicker" title="Instructor..." data-size="10" data-live-search="true"></select>
                          </div>
                          <div class="col">
                            <label for="ride-modal-duration" class="d-none">Ride Duration</label>
                            <select id="ride-modal-duration" class="selectpicker" title="Ride Duration..." data-size="10"></select>
                          </div>
                        </div>
                        <div id="ride-modal-rides">
                          <div class="d-flex justify-content-center">
                            <div class="spinner-border text-secondary mx-auto my-5" role="status">
                              <span class="visually-hidden">Loading...</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade w-100" id="permissions" role="tabpanel" aria-labelledby="permissions-tab">
          <div class="row">
            <div class="col col-lg-9 mb-3">
              <ul class="list-group">
                {% for member in tournament.tournamentmember_set.all %}
                  <li id="rider-permission-row-{{ member.uid }}" class="list-group-item d-flex flex-row align-items-center rider-permission-item">
                    {% if member.peloton_profile.image_url %}
                    <img src="{{ member.peloton_profile.image_url }}" alt="{{ member.peloton_profile.username }}" width="24" height="24"
                         class="rounded-circle me-2">
                    {% else %}
                    <span class="user-icon-sm">{{ member.peloton_profile.username|first|upper }}</span>
                    {% endif %}
                    <span class="peloton-username">{{ member.peloton_profile.username }}</span>
                    <label for="select-role-{{ member.uid }}" class="d-none">Select role</label>
                    <select id="select-role-{{ member.uid }}" class="selectpicker ms-auto role-selector">
                      {% for role, display_name in tournament.roles %}
                      <option value="{{ role }}" {% if member.role == role %}selected{% endif %}>{{ display_name }}</option>
                      {% endfor %}
                    </select>
                  </li>
                {% endfor %}
              </ul>
            </div>
            <div class="col-12">
              <button type="button" class="btn btn-primary" onclick="savePermissions();">Save Changes</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}